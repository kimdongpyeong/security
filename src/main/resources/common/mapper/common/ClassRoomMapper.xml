<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="kr.supporti.api.common.mapper.ClassRoomMapper">

    <sql id="selectFrom">
        SELECT
           `classroom`.`id`,
           `classroom`.`type`,
           `classroom`.`title`,
           `classroom`.`member_num`,
           `classroom_user`.`user_id`,
           `classroom`.`category_id`,
           `classroom`.`etc`,
           `classroom`.`open_type`,
           `classroom`.`enter_code`,
           `classroom`.`origin_file_nm`,
           `classroom`.`save_file_nm`,
           `classroom`.`file_size`,
           `classroom`.`delete_yn`,
           `classroom`.`created_by`,
            (SELECT `live_time`.`end_time` FROM `tb_classroom_live_time` `live_time` WHERE `classroom`.id = `live_time`.classroom_id) AS `class_end_time`,
            (SELECT `user`.`name` FROM `tb_user` `user` WHERE `classroom`.created_by = `user`.id) AS `created_by_nm`,
           `classroom`.`created_date`,
           `classroom`.`last_modified_date`
        FROM
            `tb_classroom` `classroom`
        LEFT JOIN
            `tb_classroom_user` `classroom_user`
        ON
            `classroom`.`id` = `classroom_user`.`classroom_id`
    </sql>

    <sql id="where">
        <where>
            <if test="classRoomParamDto.deleteYn != null and classRoomParamDto.deleteYn != ''">
                AND `classroom`.`delete_yn` = #{classRoomParamDto.deleteYn}
            </if>
            <if test="classRoomParamDto.createdBy != null and classRoomParamDto.createdBy != ''">
                AND `classroom`.`created_by` = #{classRoomParamDto.createdBy}
            </if>
            <if test="classRoomParamDto.enterCode != null and classRoomParamDto.enterCode != ''">
                AND `classroom`.`enter_code` = #{classRoomParamDto.enterCode}
            </if>
            <if test="classRoomParamDto.id != null and classRoomParamDto.id != ''">
                AND `classroom`.`id` = #{classRoomParamDto.id}
            </if>
            <if test="classRoomParamDto.userId != null and classRoomParamDto.userId != ''">
                AND
                    `classroom_user`.`user_id` = #{classRoomParamDto.userId}
            </if>
            <if test="classRoomParamDto.title != null and classRoomParamDto.title != ''">
                AND `classroom`.`title` = #{classRoomParamDto.title}
            </if>
        </where>
    </sql>

    <resultMap id="classRoomResultMap" type="kr.supporti.api.common.entity.ClassRoomEntity">
        <result property="id" column="id"/>
        <result property="type" column="type"/>
        <result property="title" column="title"/>
        <result property="userId" column="user_id"/>
        <result property="memberNum" column="member_num"/>
        <result property="categoryId" column="category_id"/>
        <result property="etc" column="etc"/>
        <result property="openType" column="open_type"/>
        <result property="enterCode" column="enter_code"/>
        <result property="classEndTime" column="class_end_time"/>
        <result property="originFileNm" column="origin_file_nm"/>
        <result property="saveFileNm" column="save_file_nm"/>
        <result property="fileSize" column="file_size"/>
        <result property="deleteYn" column="delete_yn"/>
        <result property="createdBy" column="created_by"/>
        <result property="createdByNm" column="created_by_nm"/>
        <result property="createdDate" column="created_date"/>
        <result property="lastModifiedDate" column="last_modified_date"/>
    </resultMap>

    <select
        id="selectClassRoomList"
        parameterType="java.util.Map"
        resultMap="classRoomResultMap"
    >
        <include refid="PageFragment.sortStart"/>
        <include refid="selectFrom"/>
        <include refid="where"/>
        GROUP BY
            `classroom`.`id`
        <include refid="PageFragment.sortEnd"/>
        <include refid="PageFragment.limitOffset"/>
    </select>

    <select
        id="selectClassRoomListCount"
        parameterType="java.util.Map"
        resultType="java.lang.Integer"
    >
        <include refid="PageFragment.countStart"/>
        <include refid="selectFrom"/>
        <include refid="where"/>
        <include refid="PageFragment.countEnd"/>
    </select>

    <select
        id="selectClassRoom"
        parameterType="java.util.Map"
        resultMap="classRoomResultMap"
    >
        <include refid="selectFrom"/>
        GROUP BY
            `classroom`.`id`
        HAVING
            `classroom`.`id` = #{id}
    </select>

    <update
        id="modifyClassRoom"
        parameterType ="java.util.Map"
    >
        UPDATE
            `tb_classroom` `classroom`
        SET
                `classroom`.`type` = #{classRoomDto.type},
                `classroom`.`title` = #{classRoomDto.title},
                `classroom`.`member_num` = #{classRoomDto.memberNum},
                `classroom`.`category_id` = #{classRoomDto.categoryId},
                `classroom`.`open_type` = #{classRoomDto.openType},
                `classroom`.`created_by` = #{classRoomDto.createdBy},
                `classroom`.`delete_yn` = #{classRoomDto.deleteYn}
            <if test="classRoomDto.etc != null and classRoomDto.etc != ''">
                , `classroom`.`etc` = #{classRoomDto.etc}
            </if>
            <if test="classRoomDto.enterCode != null and classRoomDto.enterCode != ''">
                , `classroom`.`enter_code` = #{classRoomDto.enterCode}
            </if>
            <if test="classRoomDto.originFileNm != null and classRoomDto.originFileNm != ''">
                , `classroom`.`origin_file_nm` = #{classRoomDto.originFileNm}
            </if>
            <if test="classRoomDto.saveFileNm != null and classRoomDto.saveFileNm != ''">
                , `classroom`.`save_file_nm` = #{classRoomDto.saveFileNm}
            </if>
            <if test="classRoomDto.fileSize != null and classRoomDto.fileSize != ''">
                , `classroom`.`file_size` = #{classRoomDto.fileSize}
            </if>
        WHERE
            `classroom`.`id` = #{classRoomDto.id}
    </update>

    <update
        id="removeClassRoom"
        parameterType ="java.util.Map"
    >
        UPDATE
            `tb_classroom` `classroom`
        SET
            `classroom`.`delete_yn` = 'Y'
        WHERE
            `classroom`.`id` IN
            <foreach collection="classRoomDto.deleteClass" item="item" open="(" close=")" separator="," >
                #{item}
            </foreach>
    </update>
</mapper>